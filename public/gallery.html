<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gallery - Idol Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      .file-item img, .file-item video { max-width: 100%; height: auto; border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer }
      .viewer { position: fixed; inset: 0; background: rgba(0,0,0,.9); display: none; align-items: center; justify-content: center; z-index: 9999 }
      .viewer.open { display: flex }
      .viewer-content { position: relative; max-width: 95vw; max-height: 95vh }
      .viewer-content img, .viewer-content video { max-width: 95vw; max-height: 95vh }
      .viewer-actions { position: absolute; top: .5rem; right: .5rem; display: flex; gap: .5rem }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <nav class="mb-4">
        <a href="/" class="btn btn-outline-secondary">‚Üê Back to Downloader</a>
      </nav>
      
      <h1 class="mb-4">Gallery</h1>
      
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Select Idol</h5>
          <div id="idols-container">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <div id="gallery-container">
        <div class="alert alert-info text-center">Select an idol to view files</div>
      </div>
    </div>

    <div class="viewer" id="viewer" onclick="if(event.target.id==='viewer'){closeViewer()}">
      <div class="viewer-content" id="viewerContent">
        <div class="viewer-actions">
          <button class="btn btn-light btn-sm" onclick="enterFullscreen(event)">Fullscreen</button>
          <button class="btn btn-secondary btn-sm" onclick="closeViewer(event)">Close</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
      const idolsContainer = document.getElementById('idols-container');
      const galleryContainer = document.getElementById('gallery-container');
      const viewer = document.getElementById('viewer');
      const viewerContent = document.getElementById('viewerContent');
      let selectedIdol = null;

      async function loadIdols() {
        try {
          const res = await fetch('/api/idols');
          const idols = await res.json();
          if (idols.length === 0) {
            idolsContainer.innerHTML = '<p class="text-muted">No idols found. <a href="/">Start downloading</a></p>';
            return;
          }
          idolsContainer.innerHTML = '<div class="btn-group flex-wrap" role="group"></div>';
          const div = idolsContainer.querySelector('.btn-group');
          idols.forEach(idol => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-primary';
            btn.type = 'button';
            btn.textContent = idol;
            btn.onclick = () => selectIdol(idol);
            div.appendChild(btn);
          });
          if (idols.length > 0) selectIdol(idols[0]);
        } catch (err) {
          idolsContainer.innerHTML = '<div class="alert alert-danger">Error loading idols: ' + err.message + '</div>';
        }
      }

      async function selectIdol(idol) {
        selectedIdol = idol;
        document.querySelectorAll('.btn-outline-primary').forEach(btn => {
          btn.classList.toggle('active', btn.textContent === idol);
        });
        try {
          const res = await fetch(`/api/files/${idol}`);
          const files = await res.json();
          if (files.length === 0) {
            galleryContainer.innerHTML = '<div class="alert alert-warning text-center">No files found for ' + idol + '</div>';
            return;
          }
          galleryContainer.innerHTML = '<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3"></div>';
          const gallery = galleryContainer.querySelector('.row');
          files.forEach(file => {
            const col = document.createElement('div');
            col.className = 'col';
            const card = document.createElement('div');
            card.className = 'card h-100';
            const isVideo = /\.(mp4|webm|ogg)$/i.test(file.name);
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name);
            if (isVideo) {
              const vid = document.createElement('video');
              vid.className = 'card-img-top';
              vid.src = file.path;
              vid.controls = true;
              vid.muted = true;
              vid.loop = true;
              vid.playsInline = true;
              vid.onclick = () => openViewer('video', file.path);
              card.appendChild(vid);
            } else if (isImage) {
              const img = document.createElement('img');
              img.className = 'card-img-top';
              img.src = file.path;
              img.alt = file.name;
              img.onerror = () => { img.style.display = 'none'; };
              img.onclick = () => openViewer('image', file.path);
              card.appendChild(img);
            }
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column';
            const name = document.createElement('div');
            name.className = 'small text-truncate mb-1';
            name.textContent = file.name;
            cardBody.appendChild(name);
            const size = document.createElement('div');
            size.className = 'text-muted small mb-2';
            size.textContent = formatSize(file.size);
            cardBody.appendChild(size);
            const download = document.createElement('a');
            download.className = 'btn btn-success btn-sm mt-auto';
            download.href = `/files/download/${idol}/${encodeURIComponent(file.name)}`;
            download.download = file.name;
            download.textContent = 'Download';
            cardBody.appendChild(download);
            card.appendChild(cardBody);
            col.appendChild(card);
            gallery.appendChild(col);
          });
        } catch (err) {
          galleryContainer.innerHTML = '<div class="alert alert-danger text-center">Error loading files: ' + err.message + '</div>';
        }
      }

      function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }

      function openViewer(kind, src) {
        viewerContent.querySelectorAll('img,video').forEach(n => n.remove());
        if (kind === 'video') {
          const v = document.createElement('video');
          v.src = src;
          v.controls = true;
          v.autoplay = true;
          v.loop = true;
          v.muted = false;
          v.playsInline = true;
          viewerContent.appendChild(v);
        } else {
          const i = document.createElement('img');
          i.src = src;
          viewerContent.appendChild(i);
        }
        viewer.classList.add('open');
      }

      function closeViewer(e){ if(e) e.stopPropagation(); viewer.classList.remove('open'); }
      function enterFullscreen(e){
        if(e) e.stopPropagation();
        const el = viewerContent.firstElementChild || viewerContent;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
      }

      loadIdols();
    </script>
  </body>
</html>