<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Idol Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      .log { background:#111; color:#0f0; padding:1rem; height: 300px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.875rem; border-radius: 0.375rem; }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <nav class="mb-4">
        <a href="/gallery" class="btn btn-outline-primary">View Gallery â†’</a>
      </nav>
      <div id="alertContainer" class="mb-3"></div>
      
      <h1 class="mb-4">Idolfap.com Downloader</h1>
      
      <!-- Navigation Tabs -->
      <ul class="nav nav-tabs mb-4" id="downloadTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button" role="tab" aria-controls="batch" aria-selected="true">
            Batch Download
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="post-tab" data-bs-toggle="tab" data-bs-target="#post" type="button" role="tab" aria-controls="post" aria-selected="false">
            Post URL
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="creator-tab" data-bs-toggle="tab" data-bs-target="#creator" type="button" role="tab" aria-controls="creator" aria-selected="false">
            Creator Download
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="downloadTabContent">
        <!-- Batch Download Tab -->
        <div class="tab-pane fade show active" id="batch" role="tabpanel" aria-labelledby="batch-tab">
          <div class="card">
            <div class="card-body">
              <form id="f">
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label for="idol" class="form-label">Idol</label>
                    <input type="text" class="form-control" id="idol" name="idol" required placeholder="kazuha" />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="start" class="form-label">Start Page</label>
                    <input type="number" class="form-control" id="start" name="start" min="1" value="1" required />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="end" class="form-label">End Page</label>
                    <input type="number" class="form-control" id="end" name="end" min="1" value="1" required />
                  </div>
                </div>
                <div class="btn-group mt-3" role="group">
                  <button type="submit" class="btn btn-primary" id="downloadBtn">Download</button>
                  <button type="button" class="btn btn-danger" id="stopBtn" disabled>Stop</button>
                </div>
              </form>
            </div>
          </div>
        </div>


        <!-- Post URL Tab -->
        <div class="tab-pane fade" id="post" role="tabpanel" aria-labelledby="post-tab">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-4">Download Images From Post</h5>
              <form id="postUrlForm">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label for="idolPost" class="form-label">Idol</label>
                    <input type="text" class="form-control" id="idolPost" placeholder="kazuha" required />
                    <div class="form-text">The idol folder name to save images to.</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label for="postUrl" class="form-label">Post URL</label>
                    <input type="url" class="form-control" id="postUrl" placeholder="https://idolfap.com/post/115067/" required />
                  </div>
                </div>
                <div class="btn-group mt-3" role="group">
                  <button type="submit" class="btn btn-success" id="downloadPostBtn">Download Post</button>
                  <button type="button" class="btn btn-danger" id="stopPostBtn" disabled>Stop</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Creator Download Tab -->
        <div class="tab-pane fade" id="creator" role="tabpanel" aria-labelledby="creator-tab">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-4">Download From Creator Pages</h5>
              <form id="creatorForm">
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label for="creatorName" class="form-label">Creator</label>
                    <input type="text" class="form-control" id="creatorName" placeholder="darkyeji" required />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="creatorStart" class="form-label">Start Page</label>
                    <input type="number" class="form-control" id="creatorStart" min="1" value="1" required />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="creatorEnd" class="form-label">End Page</label>
                    <input type="number" class="form-control" id="creatorEnd" min="1" value="1" required />
                  </div>
                </div>
                <div class="btn-group mt-3" role="group">
                  <button type="submit" class="btn btn-warning" id="downloadCreatorBtn">Download Creator</button>
                  <button type="button" class="btn btn-danger" id="stopCreatorBtn" disabled>Stop</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Logs (shared across all tabs) -->
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">Logs</h5>
        </div>
        <div class="card-body p-0">
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
      function setLoading(btn, loading, label) {
        if (!btn) return;
        if (loading) {
          btn.dataset._label = btn.textContent;
          btn.disabled = true;
          btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${label || btn.dataset._label || 'Loading...'}`;
        } else {
          btn.disabled = false;
          const text = btn.dataset._label || 'Submit';
          btn.textContent = text;
          delete btn.dataset._label;
        }
      }

      function showAlert(message, type = 'success') {
        const wrap = document.getElementById('alertContainer');
        const el = document.createElement('div');
        el.className = `alert alert-${type} alert-dismissible fade show`;
        el.role = 'alert';
        el.innerHTML = `
          <div>${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        wrap.appendChild(el);
        setTimeout(() => {
          try { el.classList.remove('show'); el.classList.add('hide'); el.remove(); } catch {}
        }, 8000);
      }
      const form = document.getElementById('f');
      const log = document.getElementById('log');
      const downloadBtn = document.getElementById('downloadBtn');
      const stopBtn = document.getElementById('stopBtn');
      const stopPostBtn = document.getElementById('stopPostBtn');
      const stopCreatorBtn = document.getElementById('stopCreatorBtn');
      const downloadPostBtn = document.getElementById('downloadPostBtn');
      const downloadCreatorBtn = document.getElementById('downloadCreatorBtn');
      let es;
      let isRunning = false;
      
      // Global state: any download running
      let anyDownloadRunning = false;
      
      function setAllDownloadButtonsEnabled(enabled) {
        downloadBtn.disabled = !enabled;
        downloadPostBtn.disabled = !enabled;
        downloadCreatorBtn.disabled = !enabled;
      }
      
      let hasShownConnectMessage = false;
      function openStream(){
        if (es) es.close();
        es = new EventSource('/logs');
        es.onmessage = (e) => {
          // Skip ping messages
          if (e.data.trim() === ': ping') return;
          // Only show first connect message, suppress reconnects
          if (e.data.includes('Connected to logs')) {
            if (hasShownConnectMessage) return;
            hasShownConnectMessage = true;
          }
          log.textContent += e.data + '\n';
          log.scrollTop = log.scrollHeight;
        };
        es.onerror = () => {
          // EventSource auto-reconnects, suppress duplicate connect messages
        };
      }
      openStream();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isRunning || anyDownloadRunning) {
          if (anyDownloadRunning && !isRunning) {
            showAlert('Another download is already running. Please wait for it to finish.', 'warning');
          }
          return;
        }
        const data = Object.fromEntries(new FormData(form).entries());
        data.start = Number(data.start);
        data.end = Number(data.end);
        log.textContent = 'Submitting...\n';
        isRunning = true;
        anyDownloadRunning = true;
        setLoading(downloadBtn, true, 'Starting...');
        stopBtn.disabled = false;
        setAllDownloadButtonsEnabled(false);
        
        try {
          const res = await fetch('/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const json = await res.json();
          log.textContent += JSON.stringify(json, null, 2) + '\n';
          if (res.ok) {
            showAlert('Batch download completed successfully.', 'success');
          } else if (res.status === 429) {
            showAlert(json.message || json.error || 'Rate limit exceeded.', 'warning');
          } else if (res.status === 409) {
            showAlert(json.error || 'Another download is already running.', 'warning');
          } else {
            showAlert(json.error || 'Batch download failed.', 'danger');
          }
        } catch (err) {
          log.textContent += 'Error: ' + err.message + '\n';
          showAlert(err.message, 'danger');
        } finally {
          isRunning = false;
          anyDownloadRunning = false;
          setLoading(downloadBtn, false);
          stopBtn.disabled = true;
          setAllDownloadButtonsEnabled(true);
        }
      });

      stopBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/stop', { method: 'POST' });
          const json = await res.json();
          log.textContent += '[Stop] ' + JSON.stringify(json) + '\n';
        } catch (err) {
          log.textContent += '[Stop Error] ' + err.message + '\n';
        }
      });

      // (Removed) Single URL downloader form

      // Download images from a single post URL form
      document.getElementById('postUrlForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (anyDownloadRunning) {
          showAlert('Another download is already running. Please wait for it to finish.', 'warning');
          return;
        }
        const idolPost = document.getElementById('idolPost').value.trim();
        const postUrl = document.getElementById('postUrl').value.trim();
        if (!idolPost || !postUrl) {
          log.textContent += 'Error: Idol and Post URL are required.\n';
          log.scrollTop = log.scrollHeight;
          return;
        }
        const btn = document.getElementById('downloadPostBtn');
        anyDownloadRunning = true;
        setLoading(btn, true, 'Downloading...');
        stopPostBtn.disabled = false;
        setAllDownloadButtonsEnabled(false);
        log.textContent += `[Post] Downloading images from ${postUrl}...\n`;
        log.scrollTop = log.scrollHeight;
        try {
          const res = await fetch('/download-post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idol: idolPost, postUrl })
          });
          const json = await res.json();
          log.textContent += '[Post] ' + JSON.stringify(json) + '\n';
          if (res.ok) {
            showAlert('Post download completed successfully.', 'success');
          } else if (res.status === 429) {
            showAlert(json.message || json.error || 'Rate limit exceeded.', 'warning');
          } else if (res.status === 409) {
            showAlert(json.error || 'Another download is already running.', 'warning');
          } else {
            showAlert(json.error || 'Post download failed.', 'danger');
          }
          log.scrollTop = log.scrollHeight;
        } catch (err) {
          log.textContent += '[Post Error] ' + err.message + '\n';
          log.scrollTop = log.scrollHeight;
          showAlert(err.message, 'danger');
        } finally {
          anyDownloadRunning = false;
          setLoading(btn, false);
          stopPostBtn.disabled = true;
          setAllDownloadButtonsEnabled(true);
        }
      });

      stopPostBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/stop', { method: 'POST' });
          const json = await res.json();
          log.textContent += '[Stop Post] ' + JSON.stringify(json) + '\n';
          log.scrollTop = log.scrollHeight;
        } catch (err) {
          log.textContent += '[Stop Post Error] ' + err.message + '\n';
          log.scrollTop = log.scrollHeight;
        }
      });

      // Creator download form
      document.getElementById('creatorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (anyDownloadRunning) {
          showAlert('Another download is already running. Please wait for it to finish.', 'warning');
          return;
        }
        const creator = document.getElementById('creatorName').value.trim();
        const start = parseInt(document.getElementById('creatorStart').value, 10);
        const end = parseInt(document.getElementById('creatorEnd').value, 10);
        if (!creator || !start || !end) {
          log.textContent += 'Error: Creator, Start, End are required.\n';
          log.scrollTop = log.scrollHeight;
          return;
        }
        const btn = document.getElementById('downloadCreatorBtn');
        anyDownloadRunning = true;
        setLoading(btn, true, 'Downloading...');
        stopCreatorBtn.disabled = false;
        setAllDownloadButtonsEnabled(false);
        log.textContent += `[Creator] Downloading ${creator} pages ${start}-${end}...\n`;
        log.scrollTop = log.scrollHeight;
        try {
          const res = await fetch('/download-creator', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ creator, start, end })
          });
          const json = await res.json();
          log.textContent += '[Creator] ' + JSON.stringify(json) + '\n';
          if (res.ok) {
            showAlert('Creator download completed successfully.', 'success');
          } else if (res.status === 429) {
            showAlert(json.message || json.error || 'Rate limit exceeded.', 'warning');
          } else if (res.status === 409) {
            showAlert(json.error || 'Another download is already running.', 'warning');
          } else {
            showAlert(json.error || 'Creator download failed.', 'danger');
          }
          log.scrollTop = log.scrollHeight;
        } catch (err) {
          log.textContent += '[Creator Error] ' + err.message + '\n';
          log.scrollTop = log.scrollHeight;
          showAlert(err.message, 'danger');
        } finally {
          anyDownloadRunning = false;
          setLoading(btn, false);
          stopCreatorBtn.disabled = true;
          setAllDownloadButtonsEnabled(true);
        }
      });

      stopCreatorBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/stop', { method: 'POST' });
          const json = await res.json();
          log.textContent += '[Stop Creator] ' + JSON.stringify(json) + '\n';
          log.scrollTop = log.scrollHeight;
        } catch (err) {
          log.textContent += '[Stop Creator Error] ' + err.message + '\n';
          log.scrollTop = log.scrollHeight;
        }
      });
    </script>
  </body>
</html>